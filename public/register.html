<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Register</title>
    <link rel="stylesheet" href="register.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <link rel="stylesheet" href="topbar_style.css" />
  </head>
  <body>
    <div class="main-Conatiner">
      <div class="Top-Bar">
        <img
          src="./Assets/logo.jpg"
          class="logo"
          alt="Company Logo"
          onclick="window.location.href='index.html'"
        />

        <div class="search">
          <input
            type="text"
            name="Search-bar"
            placeholder="Search..."
            class="searchbox"
          />
          <button type="submit" class="search-icon">
            <i class="fa fa-search"></i>
          </button>
        </div>

        <div class="icon-group">
          <div class="wrapper profile-wrapper">
            <button
              type="button"
              class="profile-icon"
              id="profileBtn"
              aria-label="Profile"
              title="Profile"
            >
              <i class="fa fa-user" style="font-size: 28px"></i>
            </button>
            <div class="profile-dropdown" id="profileDropdown">
              <p class="profile-email">None</p>
              <br />
              <a href="profile.html">My Profile</a><br />
              <button
                id="logoutBtn"
                style="
                  background: none;
                  border: none;
                  color: #1c2a33;
                  cursor: pointer;
                  padding: 0;
                  margin: 0;
                  text-align: center;
                  width: 100%;
                "
              >
                Logout
              </button>
            </div>
          </div>
          <button
            type="button"
            class="profile-icon"
            aria-label="Go to cart"
            title="Cart"
            id="cartBtn"
          >
            <i class="fa fa-shopping-cart" style="font-size: 22px"></i>
            <span id="cartCount" class="cart-count">0</span>
          </button>
        </div>

        <div class="button-container">
          <div class="wrapper">
            <button class="contact-btn" id="emailBtn">
              <i class="fa fa-envelope"></i>
            </button>
            <div class="contact-box" id="emailBox">
              Shehab200088111@gmail.com
            </div>
          </div>

          <div class="wrapper">
            <button class="contact-btn" id="phoneBtn">
              <i class="fa fa-phone"></i>
            </button>
            <div class="contact-box" id="phoneBox">+201023323888</div>
          </div>
        </div>
      </div>

      <h1 class="Header">Register Form</h1>

      <div class="register-container">
        <form class="register-form">
          <fieldset>
            <legend>Personal Info</legend>
            <input
              id="firstName"
              type="text"
              placeholder="First Name"
              required
            />
            <input id="lastName" type="text" placeholder="Last Name" required />
            <input id="emailInput" type="email" placeholder="Email" required />
            <input id="phone" type="tel" placeholder="Phone" required />
          </fieldset>

          <fieldset>
            <legend>Passwords</legend>
            <input type="password" placeholder="Password" required />
            <input type="password" placeholder="Confirm Password" required />
            <input type="text" placeholder="Security Question" required />
            <input
              type="text"
              placeholder="Security Question Answer"
              required
            />
          </fieldset>

          <fieldset>
            <legend>Get News</legend>
            <label>Receive mail for updates and offers?</label>
            <div class="radio-group">
              <label><input type="radio" name="news" value="yes" /> Yes</label>
              <label><input type="radio" name="news" value="no" /> No</label>
            </div>
          </fieldset>

          <div class="terms">
            <label>
              <input type="checkbox" required /> I agree to terms and services
            </label>
          </div>

          <button type="submit" class="register-btn">Register</button>
        </form>
      </div>

      <div class="footer">
        <div class="feet-contact">
          <ul class="foot-contact">
            <li class="focus">Contact</li>
            <li>Email: Shehab200088111@gmail.com</li>
            <li>Phone number: +201023323888</li>
          </ul>
        </div>
        <div class="feet-tags">
          <ul class="foot-tags">
            <li class="focus">Tags</li>
            <li>Mother board</li>
            <li>CPU</li>
            <li>GPU</li>
            <li>RAM</li>
            <li>Power supply</li>
            <li>Hard Drives</li>
            <li>Accessories</li>
          </ul>
        </div>
        <div class="feet-pages">
          <ul class="foot-pages">
            <li class="focus">Pages</li>
            <li><a href="#">Feedback</a></li>
            <li><a href="#">About</a></li>
          </ul>
        </div>
      </div>
      <div class="Copywrite">&copy; 2025 Team 0. All rights reserved.</div>
    </div>

    <script src="register.js"></script>
    <script src="./topbar_js.js"></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-analytics.js";
      import {
        getFirestore,
        collection,
        getDocs,
        setDoc,
        doc,
      } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
      import {
        getAuth,
        createUserWithEmailAndPassword,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyD9ghRnC-TMJ-TV6TJxdGH_7qgRsT6Po04",
        authDomain: "project-d6110.firebaseapp.com",
        projectId: "project-d6110",
        storageBucket: "project-d6110.firebasestorage.app",
        messagingSenderId: "402041654228",
        appId: "1:402041654228:web:2430f53e2afb775e242441",
        measurementId: "G-0ZLPYLVJ4Y",
      };

      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const db = getFirestore(app);
      const auth = getAuth(app);

      const form = document.querySelector(".register-form");
      if (form) {
        form.addEventListener("submit", async (e) => {
          e.preventDefault();
          const email = form.querySelector('input[type="email"]').value;
          const firstName = form.querySelector("#firstName")?.value || "";
          const lastName = form.querySelector("#lastName")?.value || "";
          const phone = form.querySelector("#phone")?.value || "";
          const password = form.querySelectorAll('input[type="password"]')[0]
            .value;
          const confirmPassword = form.querySelectorAll(
            'input[type="password"]'
          )[1].value;

          if (password !== confirmPassword) {
            console.warn("Passwords do not match.");
            return;
          }

          try {
            const userCredential = await createUserWithEmailAndPassword(
              auth,
              email,
              password
            );
            try {
              const uid = userCredential.user.uid;
              await setDoc(doc(db, "users", uid), {
                firstName,
                lastName,
                phone,
                email,
                createdAt: new Date().toISOString(),
              });
            } catch (fsErr) {
              console.error(
                "Registered but failed to save additional profile info:",
                fsErr
              );
            }

            window.location.href = "login.html";
          } catch (error) {
            console.error("Registration error:", error);
          }
        });
      }

      function updateProfileDropdown(user) {
        const dropdown = document.getElementById("profileDropdown");
        if (!dropdown) return;

        let emailElem = dropdown.querySelector(".profile-email");
        if (!emailElem) {
          emailElem = document.createElement("p");
          emailElem.className = "profile-email";
          dropdown.prepend(emailElem);
        }

        if (user && user.email) {
          emailElem.textContent = user.email;
          dropdown.querySelector("a[href='profile.html']").style.display = "";
          const logoutBtn = dropdown.querySelector("#logoutBtn");
          if (logoutBtn) logoutBtn.style.display = "";
          if (dropdown.querySelector(".login-link")) {
            dropdown.querySelector(".login-link").remove();
          }
        } else {
          emailElem.textContent = "Not logged in";
          dropdown.querySelector("a[href='profile.html']").style.display =
            "none";
          const logoutBtn = dropdown.querySelector("#logoutBtn");
          if (logoutBtn) logoutBtn.style.display = "none";
          if (!dropdown.querySelector(".login-link")) {
            const loginLink = document.createElement("a");
            loginLink.href = "login.html";
            loginLink.textContent = "Login";
            loginLink.className = "login-link";
            loginLink.style.display = "block";
            dropdown.appendChild(loginLink);
          }
        }
      }

      window.currentUser = null;
      onAuthStateChanged(auth, (user) => {
        window.currentUser = user;
        updateProfileDropdown(user);
      });

      document.addEventListener("DOMContentLoaded", () => {
        const logoutBtn = document.getElementById("logoutBtn");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", async () => {
            try {
              await auth.signOut();
              window.location.href = "login.html";
            } catch (err) {
              console.error("Error signing out:", err);
            }
          });
        }

        document.addEventListener("click", function (event) {
          if (!event.target.closest(".profile-wrapper")) {
            document
              .getElementById("profileDropdown")
              .classList.remove("active");
          }
        });

        const profileBtn = document.getElementById("profileBtn");
        if (profileBtn) {
          profileBtn.addEventListener("click", function (e) {
            if (!window.currentUser) {
              window.location.href = "login.html";
              return;
            }
            e.stopPropagation();
            document
              .getElementById("profileDropdown")
              .classList.toggle("active");
          });
        }
      });
    </script>
  </body>
</html>
