<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cart</title>
    <link rel="stylesheet" href="cart.css" />
    <link rel="stylesheet" href="Ai.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <link rel="stylesheet" href="topbar_style.css" />
  </head>
  <body>
    <div class="main-Conatiner">
      <div class="Top-Bar">
        <img
          src="./Assets/logo.jpg"
          class="logo"
          alt="Company Logo"
          onclick="window.location.href='index.html'"
        />

        <div class="search">
          <input
            type="text"
            name="Search-bar"
            placeholder="Search..."
            class="searchbox"
          />
          <button type="submit" class="search-icon">
            <i class="fa fa-search"></i>
          </button>
        </div>

        <div class="icon-group">
          <div class="wrapper profile-wrapper">
            <button
              type="button"
              class="profile-icon"
              id="profileBtn"
              aria-label="Profile"
              title="Profile"
            >
              <i class="fa fa-user" style="font-size: 28px"></i>
            </button>
            <div class="profile-dropdown" id="profileDropdown">
              <p class="profile-email">None</p>
              <br />
              <a href="profile.html">My Profile</a><br />
              <button
                id="logoutBtn"
                style="
                  background: none;
                  border: none;
                  color: #1c2a33;
                  cursor: pointer;
                  padding: 0;
                  margin: 0;
                  text-align: center;
                  width: 100%;
                "
              >
                Logout
              </button>
            </div>
          </div>
          <button
            type="button"
            class="profile-icon"
            aria-label="Go to cart"
            title="Cart"
            id="cartBtn"
          >
            <i class="fa fa-shopping-cart" style="font-size: 22px"></i>
            <span id="cartCount" class="cart-count">0</span>
          </button>
        </div>

        <div class="button-container">
          <div class="wrapper">
            <button class="contact-btn" id="emailBtn">
              <i class="fa fa-envelope"></i>
            </button>
            <div class="contact-box" id="emailBox">
              Shehab200088111@gmail.com
            </div>
          </div>

          <div class="wrapper">
            <button class="contact-btn" id="phoneBtn">
              <i class="fa fa-phone"></i>
            </button>
            <div class="contact-box" id="phoneBox">+201023323888</div>
          </div>
        </div>
      </div>

      <h1 class="Header">Cart</h1>

      <div class="cart-container">
        <div class="order-steps">
          <div class="step">1<br /><span>Place Order</span></div>
          <div class="arrow">â†’</div>
          <div class="step">2<br /><span>Confirm Order</span></div>
          <div class="arrow">â†’</div>
          <div class="step">3<br /><span>Checkout & Deliver</span></div>
        </div>

        <div class="cart-content">
          <table class="cart-table">
            <thead>
              <tr>
                <th>Image</th>
                <th>Product Name</th>
                <th>Model</th>
                <th>Quantity</th>
                <th>Unit Price</th>
                <th>Total Price</th>
              </tr>
            </thead>
            <tbody id="cartTableBody"></tbody>
          </table>

          <div class="cart-sidebar">
            <div class="discount-box">
              <h3>Discount</h3>
              <input type="text" placeholder="Voucher code" />
              <button>Check Voucher</button>
            </div>

            <div class="checkout-box">
              <h3>Checkout</h3>
              <p>Full Total Price: <span>$630</span></p>
              <p>Discount: <span>$0</span></p>
              <p>
                <strong>Final Total: <span>$630</span></strong>
              </p>
              <button
                class="checkout-btn"
                onclick="window.location.href='checkout.html'"
              >
                Checkout
              </button>
            </div>
          </div>
        </div>
      </div>
      <button class="chat-button" id="chatButton" onclick="toggleChat()">
        <span id="chatIcon">ðŸ’¬</span>
      </button>

      <div class="chat-container" id="chatContainer">
        <div class="cc-box">
          <div class="cc-box-header clearfix">
            AI Assistant
            <span class="status-indicator status-loading" id="statusIndicator"
              >Loading...</span
            >
            <span class="pull-right" title="Close" onclick="closeChat()">
              âœ•
            </span>
          </div>

          <div class="cc-tab-container">
            <div class="cc-tab selected">CHAT</div>
          </div>

          <div class="cc-search-bar">
            <input
              class="search-input"
              type="text"
              placeholder="Search messages..."
              onkeyup="searchMessages()"
            />
          </div>

          <div class="content-area">
            <div class="chat-messages" id="chatMessages">
              <div class="message ai">
                Hello! I'm your AI assistant. I'm loading your product catalog
                now...
              </div>
            </div>

            <div class="input-area">
              <input
                class="chat-input"
                type="text"
                id="question"
                placeholder="Loading products..."
                disabled
                onkeypress="handleKeyPress(event)"
              />
              <button class="send-btn" id="sendBtn" onclick="ask()" disabled>
                Send
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="footer">
        <div class="feet-contact">
          <ul class="foot-contact">
            <li class="focus">Contact</li>
            <li>Email: Shehab200088111@gmail.com</li>
            <li>Phone number: +201023323888</li>
          </ul>
        </div>
        <div class="feet-tags">
          <ul class="foot-tags">
            <li class="focus">Tags</li>
            <li>Mother board</li>
            <li>CPU</li>
            <li>GPU</li>
            <li>RAM</li>
            <li>Power supply</li>
            <li>Hard Drives</li>
            <li>Accessories</li>
          </ul>
        </div>
        <div class="feet-pages">
          <ul class="foot-pages">
            <li class="focus">pages</li>
            <li><a href="#">Feedback</a></li>
            <li><a href="#">About</a></li>
          </ul>
        </div>
      </div>

      <div class="Copywrite">&copy; 2025 Team 0. All rights reserved.</div>
    </div>
    
    <script src="./topbar_js.js"></script>
    
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics.js";
      import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

      // ðŸ”¥ Firebase config
      const firebaseConfig = {
        apiKey: "AIzaSyD9ghRnC-TMJ-TV6TJxdGH_7qgRsT6Po04",
        authDomain: "project-d6110.firebaseapp.com",
        projectId: "project-d6110",
        storageBucket: "project-d6110.firebasestorage.app",
        messagingSenderId: "402041654228",
        appId: "1:402041654228:web:2430f53e2afb775e242441",
        measurementId: "G-0ZLPYLVJ4Y",
      };

      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const db = getFirestore(app);
      const auth = getAuth(app);

      // --------------------------
      // ðŸ”¹ Profile Dropdown Update
      // --------------------------
      function updateProfileDropdown(user) {
        const dropdown = document.getElementById("profileDropdown");
        if (!dropdown) return;
        let emailElem = dropdown.querySelector(".profile-email");
        if (!emailElem) {
          emailElem = document.createElement("p");
          emailElem.className = "profile-email";
          dropdown.prepend(emailElem);
        }

        if (user && user.email) {
          emailElem.textContent = user.email;
          dropdown.querySelector("a[href='profile.html']").style.display = "";
          const logoutBtn = dropdown.querySelector("#logoutBtn");
          if (logoutBtn) logoutBtn.style.display = "";
          if (dropdown.querySelector(".login-link")) {
            dropdown.querySelector(".login-link").remove();
          }
        } else {
          emailElem.textContent = "";
          dropdown.querySelector("a[href='profile.html']").style.display =
            "none";
          const logoutBtn = dropdown.querySelector("#logoutBtn");
          if (logoutBtn) logoutBtn.style.display = "none";
          if (!dropdown.querySelector(".login-link")) {
            const loginLink = document.createElement("a");
            loginLink.href = "login.html";
            loginLink.textContent = "Login";
            loginLink.className = "login-link";
            loginLink.style.display = "block";
            dropdown.appendChild(loginLink);
          }
        }
      }

      // --------------------------
      // ðŸ”¹ Cart Helpers
      // --------------------------
      async function getCart() {
        const local = JSON.parse(localStorage.getItem("cart")) || [];
        if (!window.currentUser) return local;

        const userRef = doc(db, "users", window.currentUser.uid);
        const snap = await getDoc(userRef);
        const remote = snap.exists() && Array.isArray(snap.data().cart) ? snap.data().cart : [];

        // Prefer remote when available; otherwise seed remote from local
        if (remote.length > 0) {
          // keep local in sync with remote
          localStorage.setItem("cart", JSON.stringify(remote));
          return remote;
        }
        if (local.length > 0) {
          await setDoc(userRef, { cart: local }, { merge: true });
          return local;
        }
        return [];
      }

      async function saveCart(cart) {
        if (window.currentUser) {
          const userRef = doc(db, "users", window.currentUser.uid);
          await setDoc(userRef, { cart }, { merge: true });
        }
        localStorage.setItem("cart", JSON.stringify(cart));
      }

      // --------------------------
      // ðŸ”¹ Stock Helpers (Check only; deduct on order confirmation)
      // --------------------------
      function wait(ms) { return new Promise(r => setTimeout(r, ms)); }

      async function getLiveStock(productId) {
        try {
          const snap = await getDoc(doc(db, "products", productId));
          if (!snap.exists()) return 0;
          return snap.data().stockQuantity || 0;
        } catch (e) {
          return 0;
        }
      }

      async function renderCart() {
        const cart = await getCart();
        const tbody = document.getElementById("cartTableBody");
        tbody.innerHTML = "";
        let fullTotal = 0;

        if (!cart || cart.length === 0) {
          const emptyRow = document.createElement("tr");
          emptyRow.innerHTML = `<td colspan="6" style="text-align:center">Your cart is empty.</td>`;
          tbody.appendChild(emptyRow);
          const totalBox = document.querySelector(".checkout-box");
          if (totalBox) {
            totalBox.querySelector("p span").textContent = `0 EGP`;
            totalBox.querySelector("strong span").textContent = `0 EGP`;
            localStorage.setItem("finalTotal", 0);
          }
          if (typeof updateCartCount === "function") {
            updateCartCount();
          }
          return;
        }

        for (const [index, item] of cart.entries()) {
          const totalPrice = item.price * item.quantity;
          fullTotal += totalPrice;

          const liveStock = await getLiveStock(item.id);
          const maxAllowed = Math.min(liveStock, 10);

          const row = document.createElement("tr");
          row.setAttribute("data-product-id", item.id);
          row.setAttribute("data-max-allowed", String(maxAllowed));
          const disableIncrease = item.quantity >= maxAllowed ? 'disabled' : '';
          const limitNote = item.quantity >= maxAllowed ? `<small style="color:#a00;display:block;margin-top:4px">Limit reached</small>` : '';
          row.innerHTML = `
        <td><img src="${item.image}" alt="${item.name}" width="60"/></td>
        <td>${item.name}</td>
        <td>${item.brand || "-"}</td>
        <td>
          <div class="quantity-control">
            <button type="button" class="decrease">-</button>
            <input type="text" value="${item.quantity}" readonly />
            <button type="button" class="increase" ${disableIncrease}>+</button>
            <button type="button" class="delete-btn">Delete</button>
            ${limitNote}
          </div>
        </td>
        <td>${item.price} EGP</td>
        <td>${totalPrice} EGP</td>
      `;

          tbody.appendChild(row);
        }

        // Update totals
        const totalBox = document.querySelector(".checkout-box");
        if (totalBox) {
          totalBox.querySelector("p span").textContent = `${fullTotal} EGP`;
          totalBox.querySelector(
            "strong span"
          ).textContent = `${fullTotal} EGP`;
          localStorage.setItem("finalTotal", fullTotal);
        }

        // Update cart icon count
        if (typeof updateCartCount === "function") {
          updateCartCount();
        }
      }

      // Efficient UI update helpers (avoid full table re-render)
      function computeFullTotal(cart) {
        return cart.reduce((sum, it) => sum + (it.price * it.quantity), 0);
      }

      function updateTotalsUI(cart) {
        const fullTotal = computeFullTotal(cart);
        const totalBox = document.querySelector(".checkout-box");
        if (totalBox) {
          totalBox.querySelector("p span").textContent = `${fullTotal} EGP`;
          totalBox.querySelector("strong span").textContent = `${fullTotal} EGP`;
        }
        localStorage.setItem("finalTotal", fullTotal);
        if (typeof updateCartCount === "function") updateCartCount();
      }

      function updateRowUI(row, item, maxAllowed) {
        // quantity input
        const qtyInput = row.querySelector(".quantity-control input");
        if (qtyInput) qtyInput.value = String(item.quantity);
        // total price cell (last td)
        const tds = row.querySelectorAll("td");
        const totalCell = tds[tds.length - 1];
        if (totalCell) totalCell.textContent = `${item.price * item.quantity} EGP`;
        // increase button state and note
        const incBtn = row.querySelector(".increase");
        const container = row.querySelector(".quantity-control");
        if (incBtn) {
          if (item.quantity >= maxAllowed) incBtn.setAttribute("disabled", "");
          else incBtn.removeAttribute("disabled");
        }
        if (container) {
          let note = container.querySelector("small");
          if (item.quantity >= maxAllowed) {
            if (!note) {
              note = document.createElement("small");
              note.style.color = "#a00";
              note.style.display = "block";
              note.style.marginTop = "4px";
              container.appendChild(note);
            }
            note.textContent = "Limit reached";
          } else if (note) {
            note.remove();
          }
        }
      }

      // --------------------------
      // ðŸ”¹ Auth State
      // --------------------------
      onAuthStateChanged(auth, (user) => {
        window.currentUser = user;
        updateProfileDropdown(user);

        // ðŸ”¥ On login/logout, load merged cart and render
        (async () => {
          await renderCart();
        })();

        const checkoutBtn = document.querySelector(".checkout-btn");
        if (checkoutBtn) {
          if (user) {
            checkoutBtn.disabled = false;
            checkoutBtn.style.opacity = "1";
            checkoutBtn.style.cursor = "pointer";
          } else {
            checkoutBtn.disabled = true;
            checkoutBtn.style.opacity = "0.5";
            checkoutBtn.style.cursor = "not-allowed";
          }
        }
      });

      // --------------------------
      // ðŸ”¹ Page Init
      // --------------------------
      document.addEventListener("DOMContentLoaded", () => {
        const logoutBtn = document.getElementById("logoutBtn");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", async () => {
            try {
              await auth.signOut();
              window.location.href = "login.html";
            } catch (err) {
              console.error("Error signing out:", err);
            }
          });
        }

        document
          .getElementById("profileBtn")
          .addEventListener("click", function (e) {
            if (!window.currentUser) {
              window.location.href = "login.html";
              return;
            }
            e.stopPropagation();
            document
              .getElementById("profileDropdown")
              .classList.toggle("active");
          });

        document.addEventListener("click", function (event) {
          if (!event.target.closest(".profile-wrapper")) {
            document
              .getElementById("profileDropdown")
              .classList.remove("active");
          }
        });

        // Render cart on page load
        renderCart();
        
        // Delegated handlers to keep buttons working after re-render
        const tbody = document.getElementById("cartTableBody");
        tbody.addEventListener("click", async (e) => {
          e.preventDefault();
          const target = e.target;
          if (!(target instanceof Element)) return;
          const row = target.closest("tr");
          if (!row) return;
          if (row.getAttribute("data-busy") === "1") return; // prevent double actions
          const productId = row.getAttribute("data-product-id");
          if (!productId) return;

          let cart = await getCart();
          const idx = cart.findIndex((it) => it.id === productId);
          if (idx === -1) return;
          const item = cart[idx];

          if (target.classList.contains("decrease")) {
            row.setAttribute("data-busy", "1");
            if (item.quantity > 1) {
              item.quantity -= 1;
            } else {
              cart.splice(idx, 1);
              // remove row immediately if deleted
              row.remove();
            }
            await saveCart(cart);
            updateTotalsUI(cart);
            if (cart[idx]) {
              const liveStock = await getLiveStock(item.id);
              const maxAllowed = Math.min(liveStock, 10);
              updateRowUI(row, cart[idx], maxAllowed);
            } else if (cart.length === 0) {
              // add empty row if no items remain
              const emptyRow = document.createElement("tr");
              emptyRow.innerHTML = `<td colspan="6" style="text-align:center">Your cart is empty.</td>`;
              tbody.appendChild(emptyRow);
            }
            row.removeAttribute("data-busy");
            return;
          }

          if (target.classList.contains("increase")) {
            row.setAttribute("data-busy", "1");
            if (item.quantity >= 10) {
              alert("You can only buy up to 10 units of this product.");
              row.removeAttribute("data-busy");
              return;
            }
            const liveStock = await getLiveStock(item.id);
            const maxAllowed = Math.min(liveStock, 10);
            if (item.quantity >= maxAllowed) {
              alert(`Only ${maxAllowed} items available for this product!`);
              row.removeAttribute("data-busy");
              return;
            }
            item.maxStock = maxAllowed;
            item.quantity += 1;
            await saveCart(cart);
            updateRowUI(row, item, maxAllowed);
            updateTotalsUI(cart);
            row.removeAttribute("data-busy");
            return;
          }

          if (target.classList.contains("delete-btn")) {
            row.setAttribute("data-busy", "1");
            cart.splice(idx, 1);
            await saveCart(cart);
            row.remove();
            updateTotalsUI(cart);
            if (cart.length === 0) {
              const emptyRow = document.createElement("tr");
              emptyRow.innerHTML = `<td colspan="6" style="text-align:center">Your cart is empty.</td>`;
              tbody.appendChild(emptyRow);
            }
            row.removeAttribute("data-busy");
            return;
          }
        });
      });
    </script>

    <script src="Ai.js"></script>
  </body>
</html>
