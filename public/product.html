<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Product</title>
    <link rel="stylesheet" href="product.css" />
    <link rel="stylesheet" href="Ai.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
    <link rel="stylesheet" href="topbar_style.css" />
  </head>
  <body>
    <div class="main-Conatiner">
      <div class="Top-Bar">
        <img
          src="./Assets/logo.jpg"
          class="logo"
          alt="Company Logo"
          onclick="window.location.href='index.html'"
        />

        <div class="search">
          <input
            type="text"
            name="Search-bar"
            placeholder="Search..."
            class="searchbox"
          />
          <button type="submit" class="search-icon">
            <i class="fa fa-search"></i>
          </button>
        </div>

        <div class="icon-group">
          <div class="wrapper profile-wrapper">
            <button
              type="button"
              class="profile-icon"
              id="profileBtn"
              aria-label="Profile"
              title="Profile"
            >
              <i class="fa fa-user" style="font-size: 28px"></i>
            </button>
            <div class="profile-dropdown" id="profileDropdown">
              <p class="profile-email">None</p>
              <br />
              <a href="profile.html">My Profile</a><br />
              <button
                id="logoutBtn"
                style="
                  background: none;
                  border: none;
                  color: #1c2a33;
                  cursor: pointer;
                  padding: 0;
                  margin: 0;
                  text-align: center;
                  width: 100%;
                "
              >
                Logout
              </button>
            </div>
          </div>
          <button
            type="button"
            class="profile-icon"
            aria-label="Go to cart"
            title="Cart"
            id="cartBtn"
          >
            <i class="fa fa-shopping-cart" style="font-size: 22px"></i>
            <span id="cartCount" class="cart-count">0</span>
          </button>
        </div>

        <div class="button-container">
          <div class="wrapper">
            <button class="contact-btn" id="emailBtn">
              <i class="fa fa-envelope"></i>
            </button>
            <div class="contact-box" id="emailBox">
              Shehab200088111@gmail.com
            </div>
          </div>

          <div class="wrapper">
            <button class="contact-btn" id="phoneBtn">
              <i class="fa fa-phone"></i>
            </button>
            <div class="contact-box" id="phoneBox">+201023323888</div>
          </div>
        </div>
      </div>

      <div class="product-header">
        <h1 class="Header">Product</h1>
        <h2 class="Name"></h2>
      </div>
      <div class="product-layout">
        <div class="gallery">
          <img src="" alt="Product image" />
        </div>
        <div class="summary">
          <div class="price-row">
            <span class="label">Price:</span><span class="value"></span>
          </div>
          <div class="price-row">
            <span class="label">In Stock:</span><span class="value ok"></span>
          </div>
          <div class="price-row">
            <span class="label">Brand:</span><span class="value"></span>
          </div>
          <div class="price-row">
            <span class="label">Model:</span><span class="value"></span>
          </div>
          <div class="price-row">
            <span class="label">Description:</span><span class="value"></span>
          </div>

          <div class="share-box">
            <button class="share-btn" data-network="facebook">
              <i class="fa fa-facebook"></i>
            </button>
            <button class="share-btn" data-network="twitter">
              <i class="fa fa-twitter"></i>
            </button>
            <button class="share-btn" data-network="linkedin">
              <i class="fa fa-linkedin"></i>
            </button>
            <button class="share-btn" data-network="copy">
              <i class="fa fa-link"></i>
            </button>
          </div>
          <div class="tags"></div>

        </div>
        <aside class="related">
          <h4>Products from the same category</h4>
          <div class="related-list"></div>
        </aside>
      </div>
      <div class="tab-panels">
        <div class="tab-panel active" id="reviews">
          <div class="reviews"></div>
        </div>
      </div>
      <button class="chat-button" id="chatButton" onclick="toggleChat()">
        <span id="chatIcon">ðŸ’¬</span>
      </button>

      <div class="chat-container" id="chatContainer">
        <div class="cc-box">
          <div class="cc-box-header clearfix">
            AI Assistant
            <span class="status-indicator status-loading" id="statusIndicator"
              >Loading...</span
            >
            <span class="pull-right" title="Close" onclick="closeChat()">
              âœ•
            </span>
          </div>

          <div class="cc-tab-container">
            <div class="cc-tab selected">CHAT</div>
          </div>

          <div class="cc-search-bar">
            <input
              class="search-input"
              type="text"
              placeholder="Search messages..."
              onkeyup="searchMessages()"
            />
          </div>

          <div class="content-area">
            <div class="chat-messages" id="chatMessages">
              <div class="message ai">
                Hello! I'm your AI assistant. I'm loading your product catalog
                now...
              </div>
            </div>

            <div class="input-area">
              <input
                class="chat-input"
                type="text"
                id="question"
                placeholder="Loading products..."
                disabled
                onkeypress="handleKeyPress(event)"
              />
              <button class="send-btn" id="sendBtn" onclick="ask()" disabled>
                Send
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="footer">
        <div class="feet-contact">
          <ul class="foot-contact">
            <li class="focus">Contact</li>
            <li>Email: Shehab200088111@gmail.com</li>
            <li>Phone number: +201023323888</li>
          </ul>
        </div>
        <div class="feet-tags">
          <ul class="foot-tags">
            <li class="focus">Tags</li>
            <li>Mother board</li>
            <li>CPU</li>
            <li>GPU</li>
            <li>RAM</li>
            <li>Power supply</li>
            <li>Hard Drives</li>
            <li>Accessories</li>
          </ul>
        </div>
        <div class="feet-pages">
          <ul class="foot-pages">
            <li class="focus">pages</li>
            <li><a href="#">Feedback</a></li>
            <li><a href="#">About</a></li>
          </ul>
        </div>
      </div>

      <div class="Copywrite">&copy; 2025 Team 0. All rights reserved.</div>
    </div>
    <script src="product.js"></script>
    <script src="main.js"></script>
    <script src="./topbar_js.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script type="module">
      import {
        doc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

      function getProductIdFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get("id");
      }

      async function loadProduct() {
        const productId = getProductIdFromUrl();
        if (!productId) return;
        try {
          const productRef = doc(db, "products", productId);
          const productSnap = await getDoc(productRef);
          if (!productSnap.exists()) return;
          const product = productSnap.data();

          const nameElem = document.querySelector(".Name");
          if (nameElem)
            nameElem.textContent = product.Name || product.name || "Product";

          const imgElem = document.querySelector(".gallery img");
          if (imgElem) imgElem.src = product.image || "./Assets/1.jpg";

          const priceElem = document.querySelector(
            ".summary .price-row:nth-child(1) .value"
          );
          if (priceElem)
            priceElem.textContent =
              (product.price ? product.price.toLocaleString() : "-") + " EGP";

          const inStockElem = document.querySelector(
            ".summary .price-row:nth-child(2) .value.ok"
          );
          if (inStockElem) {
            const stockQuantity = product.stockQuantity || 0;
            const isInStock = stockQuantity > 0;
            
            inStockElem.textContent = isInStock ? `Yes (${stockQuantity} available)` : "No";
            inStockElem.classList.toggle("ok", isInStock);
            inStockElem.classList.toggle("no", !isInStock);
          }

          const brandElem = document.querySelector(
            ".summary .price-row:nth-child(3) .value"
          );
          if (brandElem) brandElem.textContent = product.brand || "-";

          const modelElem = document.querySelector(
            ".summary .price-row:nth-child(4) .value"
          );
          if (modelElem) modelElem.textContent = product.model || "-";

          const descElem = document.querySelector(
            ".summary .price-row:nth-child(5) .value"
          );
          if (descElem) descElem.textContent = product.Description || "-";

          if (product.cate) {
            const relList = document.querySelector(".related-list");
            if (relList) {
              relList.innerHTML = "";
              const allProducts = await getDocs(collection(db, "products"));
              allProducts.forEach((docSnap) => {
                if (docSnap.id === productId) return;
                const rel = docSnap.data();
                const relCate = (rel.cate || rel.category || "").toLowerCase();
                const prodCate = product.cate.toLowerCase();
                if (relCate === prodCate) {
                  const relItem = document.createElement("a");
                  relItem.className = "related-item";
                  relItem.href = `product.html?id=${docSnap.id}`;
                  relItem.innerHTML = `
              <div class="thumb"><img src="${
                rel.image || "./Assets/1.jpg"
              }" alt="thumb" /></div>
              <div class="meta">
                <div class="r-name">${rel.Name || rel.name || ""}</div>
                <div class="r-price">${
                  rel.price ? rel.price.toLocaleString() + " EGP" : ""
                }</div>
              </div>
            `;
                  relList.appendChild(relItem);
                }
              });
            }
          }
        } catch (err) {
          console.error("Error loading product:", err);
        }
      }

      document.addEventListener("DOMContentLoaded", loadProduct);

      document.addEventListener("DOMContentLoaded", () => {
        const logoutBtn = document.getElementById("logoutBtn");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", async () => {
            try {
              await auth.signOut();
              window.location.href = "login.html";
            } catch (err) {
              console.error("Error signing out:", err);
            }
          });
        }

        document.addEventListener("click", function (event) {
          if (!event.target.closest(".profile-wrapper")) {
            document
              .getElementById("profileDropdown")
              .classList.remove("active");
          }
        });
      });

      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics.js";
      import {
        getFirestore,
        collection,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyD9ghRnC-TMJ-TV6TJxdGH_7qgRsT6Po04",
        authDomain: "project-d6110.firebaseapp.com",
        projectId: "project-d6110",
        storageBucket: "project-d6110.firebasestorage.app",
        messagingSenderId: "402041654228",
        appId: "1:402041654228:web:2430f53e2afb775e242441",
        measurementId: "G-0ZLPYLVJ4Y",
      };

      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const db = getFirestore(app);

      function updateProfileDropdown(user) {
        const dropdown = document.getElementById("profileDropdown");
        if (!dropdown) return;
        let emailElem = dropdown.querySelector(".profile-email");
        if (!emailElem) {
          emailElem = document.createElement("p");
          emailElem.className = "profile-email";
          dropdown.prepend(emailElem);
        }
        if (user && user.email) {
          emailElem.textContent = user.email;
          dropdown.querySelector("a[href='profile.html']").style.display = "";
          const logoutBtn = dropdown.querySelector("#logoutBtn");
          if (logoutBtn) logoutBtn.style.display = "";
          if (dropdown.querySelector(".login-link")) {
            dropdown.querySelector(".login-link").remove();
          }
        } else {
          emailElem.textContent = "Not logged in";
          dropdown.querySelector("a[href='profile.html']").style.display =
            "none";
          const logoutBtn = dropdown.querySelector("#logoutBtn");
          if (logoutBtn) logoutBtn.style.display = "none";
          if (!dropdown.querySelector(".login-link")) {
            const loginLink = document.createElement("a");
            loginLink.href = "login.html";
            loginLink.textContent = "Login";
            loginLink.className = "login-link";
            loginLink.style.display = "block";
            dropdown.appendChild(loginLink);
          }
        }
      }

      const auth = getAuth(app);
      window.currentUser = null;
      onAuthStateChanged(auth, (user) => {
        window.currentUser = user;
        updateProfileDropdown(user);
      });

      document
        .getElementById("profileBtn")
        .addEventListener("click", function (e) {
          if (!window.currentUser) {
            window.location.href = "login.html";
            return;
          }
          e.stopPropagation();
          document.getElementById("profileDropdown").classList.toggle("active");
        });

      (function () {
        const addBtn = document.querySelector(".cli-addcart");
        function updateCartCount() {
          const countElem = document.getElementById("cartCount");
          if (!countElem) return;
          const cart = JSON.parse(localStorage.getItem("cart")) || [];
          const totalQty = cart.reduce((s, it) => s + (it.quantity || 0), 0);
          countElem.textContent = totalQty;
        }

        updateCartCount();

        if (addBtn) {
          addBtn.addEventListener("click", async () => {
            const productId = getProductIdFromUrl();
            if (!productId) return;
            const productRef = doc(db, "products", productId);
            const productSnap = await getDoc(productRef);
            if (!productSnap.exists()) return;
            const product = productSnap.data();
            
            // Check stock availability
            const currentStock = product.stockQuantity || 0;
            if (currentStock <= 0) {
              alert("This product is out of stock!");
              return;
            }

            let cart = JSON.parse(localStorage.getItem("cart")) || [];
            const existing = cart.find((item) => item.id === productId);
            
            // Check if adding this item would exceed stock
            const currentCartQuantity = existing ? existing.quantity : 0;
            if (currentCartQuantity >= currentStock) {
              alert(`Only ${currentStock} items available in stock!`);
              return;
            }

            if (existing) {
              existing.quantity += 1;
            } else {
              cart.push({
                id: productId,
                name: product.Name || product.name,
                brand: product.brand || "",
                price: product.price || 0,
                image: product.image || "./Assets/1.jpg",
                quantity: 1,
              });
            }
            localStorage.setItem("cart", JSON.stringify(cart));
            updateCartCount();
            console.log(`${product.Name || product.name} added to cart`);
          });
        }
      })();
    </script>
    <script src="Ai.js"></script>
  </body>
</html>
