<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Home Page</title>
    <link rel="stylesheet" href="index.css" />
    <link rel="stylesheet" href="topbar_style.css" />
    <link rel="stylesheet" href="Ai.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
    />
  </head>
  <body>
    <div class="main-Conatiner">
      <div class="Top-Bar">
        <img
          src="./Assets/logo.jpg"
          class="logo"
          alt="Company Logo"
          onclick="window.location.href='index.html'"
        />

        <div class="search">
          <input
            type="text"
            name="Search-bar"
            placeholder="Search..."
            class="searchbox"
          />
          <button type="submit" class="search-icon">
            <i class="fa fa-search"></i>
          </button>
        </div>

        <div class="icon-group">
          <div class="wrapper profile-wrapper">
            <button
              type="button"
              class="profile-icon"
              id="profileBtn"
              aria-label="Profile"
              title="Profile"
            >
              <i class="fa fa-user" style="font-size: 28px"></i>
            </button>
            <div class="profile-dropdown" id="profileDropdown">
              <p class="profile-email">None</p>
              <br />
              <a href="profile.html">My Profile</a><br />
              <button id="logoutBtn">Logout</button>
            </div>
          </div>
          <button
            type="button"
            class="profile-icon"
            aria-label="Go to cart"
            title="Cart"
            id="cartBtn"
          >
            <i class="fa fa-shopping-cart" style="font-size: 22px"></i>
            <span id="cartCount" class="cart-count">0</span>
          </button>
        </div>

        <div class="button-container">
          <div class="wrapper">
            <button class="contact-btn" id="emailBtn">
              <i class="fa fa-envelope"></i>
            </button>
            <div class="contact-box" id="emailBox">
              Shehab200088111@gmail.com
            </div>
          </div>

          <div class="wrapper">
            <button class="contact-btn" id="phoneBtn">
              <i class="fa fa-phone"></i>
            </button>
            <div class="contact-box" id="phoneBox">+201023323888</div>
          </div>
        </div>
      </div>

      <div class="Secondary-container">
        <div class="catgories">
          <h2>Categories</h2>
          <ul>
            <li><a href="category.html?cate=mother board">Motherboard</a></li>
            <li><a href="category.html?cate=processor">CPU</a></li>
            <li><a href="category.html?cate=gpu">GPU</a></li>
            <li><a href="category.html?cate=ram">RAM</a></li>
            <li><a href="category.html?cate=power supply">Power supply</a></li>
            <li><a href="category.html?cate=ssd">Hard Drives</a></li>
            <li><a href="category.html?cate=accessories">Accessories</a></li>
            <li><a href="category.html">View All</a></li>
          </ul>
        </div>

        <div class="slider">
          <div class="mySlides fade">
            <img
              src="./Assets/zero.jpeg"
              class="main-image"
              alt="Product showcase"
            />
          </div>
          <div class="mySlides fade">
            <img
              src="./Assets/1.jpg"
              class="main-image"
              alt="Product showcase"
            />
          </div>
          <div class="mySlides fade">
            <img
              src="./Assets/2.png"
              class="main-image"
              alt="Product showcase"
            />
          </div>
          <div class="mySlides fade">
            <img
              src="./Assets/3.jpg"
              class="main-image"
              alt="Product showcase"
            />
          </div>
          <div class="mySlides fade">
            <img
              src="./Assets/4.png"
              class="main-image"
              alt="Product showcase"
            />
          </div>

          <button class="prev">&#10094;</button>
          <button class="next">&#10095;</button>

          <div class="dots-container">
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
          </div>
        </div>
      </div>

      <div class="carousel-wrapper" data-cate="mother board">
        <h2 class="Text-mother">Motherboards</h2>
        <button class="scroll-btn left">
          <i class="fa fa-chevron-left"></i>
        </button>

        <div class="Mother-boards"></div>

        <button class="scroll-btn right">
          <i class="fa fa-chevron-right"></i>
        </button>
      </div>
      <div class="carousel-wrapper" data-cate="processor">
        <h2 class="Text-mother">CPU</h2>
        <button class="scroll-btn left">
          <i class="fa fa-chevron-left"></i>
        </button>

        <div class="Mother-boards"></div>

        <button class="scroll-btn right">
          <i class="fa fa-chevron-right"></i>
        </button>
      </div>
      <div class="carousel-wrapper" data-cate="gpu">
        <h2 class="Text-mother">GPU</h2>
        <button class="scroll-btn left">
          <i class="fa fa-chevron-left"></i>
        </button>

        <div class="Mother-boards"></div>

        <button class="scroll-btn right">
          <i class="fa fa-chevron-right"></i>
        </button>
      </div>
      <div class="carousel-wrapper" data-cate="ram">
        <h2 class="Text-mother">RAM</h2>
        <button class="scroll-btn left">
          <i class="fa fa-chevron-left"></i>
        </button>

        <div class="Mother-boards"></div>

        <button class="scroll-btn right">
          <i class="fa fa-chevron-right"></i>
        </button>
      </div>

      <div class="carousel-wrapper" data-cate="ssd">
        <h2 class="Text-mother">Storage</h2>
        <button class="scroll-btn left">
          <i class="fa fa-chevron-left"></i>
        </button>

        <div class="Mother-boards"></div>

        <button class="scroll-btn right">
          <i class="fa fa-chevron-right"></i>
        </button>
      </div>
      <div class="carousel-wrapper" data-cate="power supply">
        <h2 class="Text-mother">Power supply</h2>
        <button class="scroll-btn left">
          <i class="fa fa-chevron-left"></i>
        </button>

        <div class="Mother-boards"></div>

        <button class="scroll-btn right">
          <i class="fa fa-chevron-right"></i>
        </button>
      </div>
      <div class="carousel-wrapper" data-cate="cases">
        <h2 class="Text-mother">Case</h2>
        <button class="scroll-btn left">
          <i class="fa fa-chevron-left"></i>
        </button>

        <div class="Mother-boards"></div>

        <button class="scroll-btn right">
          <i class="fa fa-chevron-right"></i>
        </button>
      </div>

      <div class="carousel-wrapper" data-cate="fans & coolers">
        <h2 class="Text-mother">Cooling</h2>
        <button class="scroll-btn left">
          <i class="fa fa-chevron-left"></i>
        </button>

        <div class="Mother-boards"></div>

        <button class="scroll-btn right">
          <i class="fa fa-chevron-right"></i>
        </button>
      </div>

      <div class="carousel-wrapper" data-cate="accessories">
        <h2 class="Text-mother">Accessories</h2>
        <button class="scroll-btn left">
          <i class="fa fa-chevron-left"></i>
        </button>

        <div class="Mother-boards"></div>

        <button class="scroll-btn right">
          <i class="fa fa-chevron-right"></i>
        </button>
      </div>
      <button class="chat-button" id="chatButton" onclick="toggleChat()">
        <span id="chatIcon">ðŸ’¬</span>
      </button>

      <div class="chat-container" id="chatContainer">
        <div class="cc-box">
          <div class="cc-box-header clearfix">
            AI Assistant
            <span class="status-indicator status-loading" id="statusIndicator"
              >Loading...</span
            >
            <span class="pull-right" title="Close" onclick="closeChat()">
              âœ•
            </span>
          </div>

          <div class="cc-tab-container">
            <div class="cc-tab selected">CHAT</div>
          </div>

          <div class="cc-search-bar">
            <input
              class="search-input"
              type="text"
              placeholder="Search messages..."
              onkeyup="searchMessages()"
            />
          </div>

          <div class="content-area">
            <div class="chat-messages" id="chatMessages">
              <div class="message ai">
                Hello! I'm your AI assistant. I'm loading your product catalog
                now...
              </div>
            </div>

            <div class="input-area">
              <input
                class="chat-input"
                type="text"
                id="question"
                placeholder="Loading products..."
                disabled
                onkeypress="handleKeyPress(event)"
              />
              <button class="send-btn" id="sendBtn" onclick="ask()" disabled>
                Send
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="footer">
        <div class="feet-contact">
          <ul class="foot-contact">
            <li class="focus">Contact</li>
            <li>Email: Shehab200088111@gmail.com</li>
            <li>Phone number: +201023323888</li>
          </ul>
        </div>
        <div class="feet-tags">
          <ul class="foot-tags">
            <li class="focus">Tags</li>
            <li>Motherboard</li>
            <li>CPU</li>
            <li>GPU</li>
            <li>RAM</li>
            <li>Power supply</li>
            <li>Hard Drives</li>
            <li>Accessories</li>
          </ul>
        </div>
        <div class="feet-pages">
          <ul class="foot-pages">
            <li class="focus">Pages</li>
            <li><a href="#">Feedback</a></li>
            <li><a href="#">About</a></li>
          </ul>
        </div>
      </div>

      <footer class="Copywrite">
        &copy; 2025 Team 0. All rights reserved.
      </footer>
    </div>

    <script src="topbar_js.js"></script>
    <script src="index.js"></script>
    
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
      import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics.js";
      import {
        getFirestore,
        collection,
        getDocs,
        doc,
        setDoc,
        getDoc,
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
      import {
        getAuth,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

      // ---------------- FIREBASE CONFIG ----------------
      const firebaseConfig = {
        apiKey: "AIzaSyD9ghRnC-TMJ-TV6TJxdGH_7qgRsT6Po04",
        authDomain: "project-d6110.firebaseapp.com",
        projectId: "project-d6110",
        storageBucket: "project-d6110.firebasestorage.app",
        messagingSenderId: "402041654228",
        appId: "1:402041654228:web:2430f53e2afb775e242441",
        measurementId: "G-0ZLPYLVJ4Y",
      };

      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const db = getFirestore(app);
      const auth = getAuth(app);

      let currentUser = null;
      onAuthStateChanged(auth, (user) => {
        currentUser = user;
        updateProfileDropdown(user);
      });

      // ---------------- CART UTILS ----------------
      function getCart() {
        return JSON.parse(localStorage.getItem("cart")) || [];
      }

      function updateCart(cart) {
        localStorage.setItem("cart", JSON.stringify(cart));
        updateCartCount();
      }

      function updateCartCount() {
        const cart = getCart();
        const count = cart.reduce((sum, item) => sum + item.quantity, 0);
        const cartCountElem = document.getElementById("cartCount");

        if (cartCountElem) {
          if (count > 0) {
            cartCountElem.textContent = count;
            cartCountElem.style.display = "inline-block";
          } else {
            cartCountElem.style.display = "none";
          }
        }
      }

      async function syncCartToFirestore(product) {
        if (!currentUser) return; // only logged-in users

        const userRef = doc(db, "users", currentUser.uid);
        try {
          const userSnap = await getDoc(userRef);
          let userCart = [];

          if (userSnap.exists() && userSnap.data().cart) {
            userCart = userSnap.data().cart;
          }

          // Merge with localStorage cart so both stay consistent
          const localCart = getCart();
          const idToItem = new Map();
          for (const it of userCart) idToItem.set(it.id, { ...it });
          for (const it of localCart) {
            if (idToItem.has(it.id)) {
              const merged = idToItem.get(it.id);
              merged.quantity = (merged.quantity || 0) + (it.quantity || 0);
              idToItem.set(it.id, merged);
            } else {
              idToItem.set(it.id, { ...it });
            }
          }
          const existingItem = idToItem.get(product.id);
          if (existingItem) existingItem.quantity = (existingItem.quantity || 0) + 1;
          else idToItem.set(product.id, { ...product });
          userCart = Array.from(idToItem.values());

          await setDoc(userRef, { cart: userCart }, { merge: true });
          console.log("âœ… Cart updated in Firestore!");
        } catch (err) {
          console.error("âŒ Error saving cart to Firestore:", err);
        }
      }

      // Ensure Firestore has local cart after login
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          const localCart = getCart();
          if (localCart.length > 0) {
            const userRef = doc(db, "users", user.uid);
            const snap = await getDoc(userRef);
            const remote = snap.exists() && snap.data().cart ? snap.data().cart : [];
            if (remote.length === 0) {
              await setDoc(userRef, { cart: localCart }, { merge: true });
            }
          }
        }
      });

      // ---------------- STOCK CHECK (no reservation during shopping) ----------------
      async function fetchCurrentStock(productId) {
        try {
          const snap = await getDoc(doc(db, "products", productId));
          if (!snap.exists()) return 0;
          return snap.data().stockQuantity || 0;
        } catch (e) {
          return 0;
        }
      }

      // ---------------- PROFILE DROPDOWN ----------------
      function updateProfileDropdown(user) {
        const dropdown = document.getElementById("profileDropdown");
        if (!dropdown) return;
        let emailElem = dropdown.querySelector(".profile-email");
        if (!emailElem) {
          emailElem = document.createElement("p");
          emailElem.className = "profile-email";
          dropdown.prepend(emailElem);
        }
        if (user && user.email) {
          emailElem.textContent = user.email;
        } else {
          emailElem.textContent = "Not logged in";
        }
      }

      // ---------------- PRODUCT CARD ----------------
      function createProductCard(product) {
        const card = document.createElement("div");
        card.classList.add("mother-cards");
        card.innerHTML = `
      <div class="mother-image">
        <img src="${product.image || "./Assets/1.jpg"}" class="theimage" alt="${
          product.Name || product.name
        }" />
      </div>
      <div class="brand">${product.brand || ""}</div>
      <div class="description">${product.Name || product.name}</div>
      <div class="price">${
        product.price ? product.price.toLocaleString() : ""
      } EGP</div>
      <div class="stock-status">${
        (product.stockQuantity || 0) > 0 
          ? `<span class="in-stock">In Stock</span>` 
          : '<span class="out-of-stock">Out of Stock</span>'
      }</div>
      <div class="actions-row">
        <div class="add-tocart">
          <button class="cli-addcart" ${(product.stockQuantity || 0) <= 0 ? 'disabled' : ''}>${
            (product.stockQuantity || 0) > 0 ? 'Add to cart' : 'Out of Stock'
          }</button>
        </div>
        <div class="view-product">
          <button class="cli-view">View product</button>
        </div>
      </div>
    `;

        // --- ADD TO CART BUTTON ---
        const addBtn = card.querySelector(".cli-addcart");
        const stockSpan = card.querySelector(".stock-status .in-stock");
        addBtn.addEventListener("click", async () => {
          // Enforce per-user cap of 10
          let cart = getCart();
          const existing = cart.find((item) => item.id === product.id);
          const currentCartQuantity = existing ? existing.quantity : 0;
          if (currentCartQuantity >= 10) {
            alert("You can only buy up to 10 units of this product.");
            return;
          }

          // Check live stock from Firestore (no deduction yet)
          const liveStock = await fetchCurrentStock(product.id);
          if (liveStock <= 0) {
            alert("This product is out of stock!");
            return;
          }
          const maxAllowed = Math.min(liveStock, 10);
          if (currentCartQuantity >= maxAllowed) {
            alert(`Only ${maxAllowed} items available for this product!`);
            return;
          }

          // Update local cart (no stock change in DB yet)
          if (existing) {
            existing.quantity += 1;
            existing.maxStock = maxAllowed;
          } else {
            cart.push({
              id: product.id,
              name: product.Name || product.name,
              brand: product.brand || "",
              price: product.price || 0,
              image: product.image || "./Assets/1.jpg",
              quantity: 1,
              maxStock: maxAllowed,
            });
          }
          updateCart(cart);
          // Write entire local cart to Firestore (source of truth) to avoid double increments
          if (currentUser) {
            try {
              const userRef = doc(db, "users", currentUser.uid);
              await setDoc(userRef, { cart }, { merge: true });
            } catch (e) {
              console.warn("Failed to sync full cart to Firestore", e);
            }
          }

          console.log(`${product.Name || product.name} added to cart`);
        });

        // --- VIEW PRODUCT BUTTON ---
        const viewBtn = card.querySelector(".cli-view");
        if (viewBtn) {
          viewBtn.addEventListener("click", () => {
            window.location.href = `product.html?id=${product.id}`;
          });
        }

        return card;
      }

      // ---------------- SCROLL ----------------
      function setupScrollButtons() {
        document.querySelectorAll(".carousel-wrapper").forEach((wrapper) => {
          const container = wrapper.querySelector(".Mother-boards");
          const leftBtn = wrapper.querySelector(".scroll-btn.left");
          const rightBtn = wrapper.querySelector(".scroll-btn.right");

          if (!container || !leftBtn || !rightBtn) return;

          const card = container.querySelector(".mother-cards");
          const cardWidth = card ? card.offsetWidth : container.offsetWidth / 3;
          const gap = 16;

          rightBtn.addEventListener("click", () => {
            container.scrollBy({ left: cardWidth + gap, behavior: "smooth" });
          });

          leftBtn.addEventListener("click", () => {
            container.scrollBy({
              left: -(cardWidth + gap),
              behavior: "smooth",
            });
          });
        });
      }

      // ---------------- LOAD PRODUCTS ----------------
      async function loadProducts() {
        try {
          const querySnapshot = await getDocs(collection(db, "products"));
          const products = [];
          querySnapshot.forEach((doc) => {
            products.push({ id: doc.id, ...doc.data() });
          });

          const params = new URLSearchParams(window.location.search);
          const q = (params.get("search") || "").trim().toLowerCase();

          if (q) {
            // --- SEARCH MODE ---
            const filtered = products.filter((p) => {
              const name = (p.Name || p.name || "").toLowerCase();
              const brand = (p.brand || "").toLowerCase();
              const cate = (p.cate || p.category || "").toLowerCase();
              const desc = (p.description || "").toLowerCase();
              return (
                name.includes(q) ||
                brand.includes(q) ||
                cate.includes(q) ||
                desc.includes(q)
              );
            });

            document
              .querySelector(".slider")
              ?.setAttribute("style", "display:none");
            document
              .querySelector(".catgories")
              ?.setAttribute("style", "display:none");
            document
              .querySelectorAll(".carousel-wrapper")
              .forEach((el) => el.setAttribute("style", "display:none"));

            let results = document.querySelector(".search-results");
            if (!results) {
              results = document.createElement("main");
              results.className = "search-results";
              results.innerHTML = `
            <h2 class="Text-mother">Search results</h2>
            <div class="Mother-boards"></div>
          `;
              const insertBefore =
                document.querySelector(".footer") ||
                document.querySelector("footer.Copywrite");
              document
                .querySelector(".main-Conatiner")
                .insertBefore(results, insertBefore);
            } else {
              results.querySelector(".Mother-boards").innerHTML = "";
            }

            const container = results.querySelector(".Mother-boards");
            if (filtered.length === 0) {
              container.innerHTML = `<p>No products found.</p>`;
            } else {
              filtered.forEach((p) =>
                container.appendChild(createProductCard(p))
              );
            }
          } else {
            // --- NORMAL MODE ---
            document
              .querySelectorAll(".Mother-boards")
              .forEach((c) => (c.innerHTML = ""));

            products.forEach((product) => {
              const category = product.cate?.toLowerCase();
              const container = document.querySelector(
                `.carousel-wrapper[data-cate="${category}"] .Mother-boards`
              );
              if (container) {
                const card = createProductCard(product);
                container.appendChild(card);
              }
            });

            setupScrollButtons();
          }
        } catch (error) {
          console.error("Error loading products:", error);
        }
      }

      // ---------------- INIT ----------------
      document.addEventListener("DOMContentLoaded", () => {
        const logoutBtn = document.getElementById("logoutBtn");
        if (logoutBtn) {
          logoutBtn.addEventListener("click", async () => {
            try {
              await auth.signOut();
              window.location.href = "login.html";
            } catch (err) {
              console.error("Error signing out:", err);
            }
          });
        }

        document.addEventListener("click", function (event) {
          if (!event.target.closest(".profile-wrapper")) {
            document
              .getElementById("profileDropdown")
              .classList.remove("active");
          }
        });

        document
          .getElementById("profileBtn")
          .addEventListener("click", function (e) {
            if (!currentUser) {
              window.location.href = "login.html";
            } else {
              e.stopPropagation();
              document
                .getElementById("profileDropdown")
                .classList.toggle("active");
            }
          });

        loadProducts();
        updateCartCount();
      });
    </script>

    <script src="Ai.js"></script>
  </body>
</html>
