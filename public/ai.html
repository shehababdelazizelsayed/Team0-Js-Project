<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>AI Chat</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            height: 100vh;
        }

        /* Chat Button */
        .chat-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background-color: #0d82b3;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1001;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            transition: all 0.3s ease;
        }

        .chat-button:hover {
            background-color: #0a6b94;
            transform: scale(1.1);
        }

        .chat-button.active {
            background-color: #666;
        }

        /* Chat Box Container */
        .chat-container {
            position: fixed;
            bottom: 90px;
            right: 20px;
            z-index: 1000;
            display: none;
            animation: slideUp 0.3s ease-out;
        }

        .chat-container.show {
            display: block;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .cc-box {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            width: 300px;
            max-height: 500px;
        }

        .cc-box-header {
            background-color: #0d82b3;
            color: white;
            padding: 12px 15px;
            border-radius: 8px 8px 0 0;
            font-weight: bold;
            position: relative;
        }

        .pull-right {
            float: right;
            cursor: pointer;
            color: white;
            font-size: 16px;
            margin-top: -2px;
            opacity: 0.8;
        }

        .pull-right:hover {
            opacity: 1;
        }

        .cc-tab-container {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e5e5e5;
        }

        .cc-tab {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-size: 12px;
            font-weight: bold;
            color: #666;
        }

        .cc-tab.selected {
            color: #0d82b3;
            border-bottom-color: #0d82b3;
        }

        .cc-search-bar {
            padding: 10px;
            background-color: white;
            border-bottom: 1px solid #e5e5e5;
        }

        .search-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 12px;
            box-sizing: border-box;
        }

        .search-input:focus {
            outline: none;
            border-color: #0d82b3;
        }

        .content-area {
            height: 320px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            background-color: white;
        }

        .message {
            margin-bottom: 10px;
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 13px;
            line-height: 1.4;
            max-width: 85%;
            word-wrap: break-word;
        }

        .message.user {
            background-color: #0d82b3;
            color: white;
            margin-left: auto;
            text-align: right;
        }

        .message.ai {
            background-color: #f5f5f5;
            border: 1px solid #e0e0e0;
            margin-right: auto;
        }

        .message.ai .content {
            line-height: 1.5;
        }

        .message.ai .content strong {
            color: #0d82b3;
            font-weight: 600;
        }

        .product-recommendation {
            background: linear-gradient(135deg, #e3f2fd 0%, #f8f9fa 100%);
            border-left: 4px solid #0d82b3;
            padding: 12px;
            margin: 8px 0;
            border-radius: 6px;
            font-size: 12px;
        }

        .product-name {
            font-weight: bold;
            color: #0d82b3;
            font-size: 13px;
            margin-bottom: 3px;
        }

        .product-price {
            color: #28a745;
            font-weight: bold;
            font-size: 12px;
        }

        .product-description {
            color: #666;
            font-size: 11px;
            margin-top: 3px;
            line-height: 1.3;
        }

        .category-header {
            background-color: #0d82b3;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin: 8px 0 4px 0;
            display: inline-block;
        }

        .recommendation-list {
            margin: 6px 0;
        }

        .error-message {
            color: #d32f2f;
            background-color: #ffebee;
            border-left: 4px solid #d32f2f;
            padding: 8px;
            border-radius: 4px;
            font-size: 12px;
        }

        .input-area {
            border-top: 1px solid #e5e5e5;
            padding: 10px;
            background-color: white;
            border-radius: 0 0 8px 8px;
            display: flex;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 20px;
            font-size: 13px;
            outline: none;
        }

        .chat-input:focus {
            border-color: #0d82b3;
        }

        .send-btn {
            padding: 8px 16px;
            background-color: #0d82b3;
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            white-space: nowrap;
        }

        .send-btn:hover {
            background-color: #0a6b94;
        }

        .send-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .thinking {
            color: #666;
            font-style: italic;
        }

        .status-indicator {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 10px;
            margin-left: 10px;
            font-weight: normal;
        }

        .status-loading {
            background-color: #fff3cd;
            color: #856404;
        }

        .status-connected {
            background-color: #d4edda;
            color: #155724;
        }

        .status-error {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* Custom scrollbar */
        .chat-messages::-webkit-scrollbar {
            width: 4px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 2px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        .clearfix::after {
            content: "";
            display: table;
            clear: both;
        }
    </style>
</head>
<body>

    <button class="chat-button" id="chatButton" onclick="toggleChat()">
        <span id="chatIcon">💬</span>
    </button>

    <div class="chat-container" id="chatContainer">
        <div class="cc-box">
            <div class="cc-box-header clearfix">
                AI Assistant
                <span class="status-indicator status-loading" id="statusIndicator">Loading...</span>
                <span class="pull-right" title="Close" onclick="closeChat()">
                    ✕
                </span>
            </div>
            
            <div class="cc-tab-container">
                <div class="cc-tab selected">
                    CHAT
                </div>
            </div>
            
            <div class="cc-search-bar">
                <input class="search-input" type="text" placeholder="Search messages..." onkeyup="searchMessages()">
            </div>
            
            <div class="content-area">
                <div class="chat-messages" id="chatMessages">
                    <div class="message ai">
                        Hello! I'm your AI assistant. I'm loading your product catalog now...
                    </div>
                </div>
                
                <div class="input-area">
                    <input class="chat-input" type="text" id="question" placeholder="Loading products..." disabled onkeypress="handleKeyPress(event)">
                    <button class="send-btn" id="sendBtn" onclick="ask()" disabled>Send</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyD9ghRnC-TMJ-TV6TJxdGH_7qgRsT6Po04",
            authDomain: "project-d6110.firebaseapp.com",
            projectId: "project-d6110",
            storageBucket: "project-d6110.firebasestorage.app",
            messagingSenderId: "402041654228",
            appId: "1:402041654228:web:2430f53e2afb775e242441",
            measurementId: "G-0ZLPYLVJ4Y"
        };

        const apiKey = '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';
        let isChatOpen = false;
        let db;
        let productsData = [];
        let productsLoaded = false;
        let firebaseInitialized = false;

        // Initialize everything on page load
        window.addEventListener('load', initializeApp);

        async function initializeApp() {
            await initializeFirebase();
            await loadProducts();
            enableChat();
        }

        async function initializeFirebase() {
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                firebaseInitialized = true;
                console.log('Firebase initialized successfully');
            } catch (error) {
                console.error('Firebase initialization error:', error);
                updateStatus('error', 'DB Error');
                addSystemMessage('❌ Failed to connect to database');
            }
        }

        async function loadProducts() {
            if (!firebaseInitialized) return;

            try {
                updateStatus('loading', 'Loading...');
                
                const snapshot = await db.collection('products').get();
                productsData = [];
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    productsData.push({
                        id: doc.id,
                        name: data.Name || data.name || 'Unknown Product',
                        price: parseFloat(data.price || 0),
                        description: data.description || '',
                        category: data.cate || data.category || 'general',
                        brand: data.brand || '',
                        stock: parseInt(data.stock || 0),
                        ...data
                    });
                });

                productsLoaded = true;
                updateStatus('connected', `${productsData.length} Products`);
                addSystemMessage(`✅ Successfully loaded ${productsData.length} products from your catalog! I can now help you with product recommendations, pricing, availability, and more.`);
                
                console.log(`Loaded ${productsData.length} products from Firebase`);
            } catch (error) {
                console.error('Error loading products:', error);
                updateStatus('error', 'Load Failed');
                addSystemMessage('❌ Failed to load products. I can still help with general questions.');
            }
        }

        function updateStatus(type, text) {
            const indicator = document.getElementById('statusIndicator');
            indicator.className = `status-indicator status-${type}`;
            indicator.textContent = text;
        }

        function addSystemMessage(message) {
            const chatMessages = document.getElementById('chatMessages');
            const systemMessage = document.createElement('div');
            systemMessage.className = 'message ai';
            systemMessage.textContent = message;
            chatMessages.appendChild(systemMessage);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function enableChat() {
            const input = document.getElementById('question');
            const sendBtn = document.getElementById('sendBtn');
            
            input.disabled = false;
            input.placeholder = "Ask me anything...";
            sendBtn.disabled = false;
        }

        function createProductContext() {
            if (!productsLoaded || productsData.length === 0) {
                return "\n\nNote: Product catalog is still loading or unavailable.";
            }
            
            let context = `\n\nAVAILABLE PRODUCTS (${productsData.length} total):\n`;
            
            // Group by category for better organization
            const categories = {};
            productsData.forEach(product => {
                const cat = product.category || 'general';
                if (!categories[cat]) categories[cat] = [];
                categories[cat].push(product);
            });

            // Add products by category (limit to prevent token overflow)
            Object.keys(categories).slice(0, 8).forEach(category => {
                context += `\n${category.toUpperCase()}:\n`;
                categories[category].slice(0, 5).forEach(product => {
                    context += `- ${product.name} | $${product.price}`;
                    if (product.description) {
                        context += ` | ${product.description.substring(0, 80)}...`;
                    }
                    context += `\n`;
                });
            });
            
            context += "\nWhen customers ask about products, provide specific recommendations from this catalog with names, prices, and reasons why they're good choices.";
            return context;
        }

        function toggleChat() {
            const chatContainer = document.getElementById('chatContainer');
            const chatButton = document.getElementById('chatButton');
            const chatIcon = document.getElementById('chatIcon');
            
            if (isChatOpen) {
                closeChat();
            } else {
                openChat();
            }
        }

        function openChat() {
            const chatContainer = document.getElementById('chatContainer');
            const chatButton = document.getElementById('chatButton');
            const chatIcon = document.getElementById('chatIcon');
            
            chatContainer.classList.add('show');
            chatButton.classList.add('active');
            chatIcon.textContent = '✕';
            isChatOpen = true;
            
            // Focus on input
            setTimeout(() => {
                document.getElementById('question').focus();
            }, 300);
        }

        function closeChat() {
            const chatContainer = document.getElementById('chatContainer');
            const chatButton = document.getElementById('chatButton');
            const chatIcon = document.getElementById('chatIcon');
            
            chatContainer.classList.remove('show');
            chatButton.classList.remove('active');
            chatIcon.textContent = '💬';
            isChatOpen = false;
        }

        async function ask() {
            const question = document.getElementById('question').value;
            const chatMessages = document.getElementById('chatMessages');
            const sendBtn = document.getElementById('sendBtn');
            
            if (!question.trim()) return;

            // Add user message
            const userMessage = document.createElement('div');
            userMessage.className = 'message user';
            userMessage.textContent = question;
            chatMessages.appendChild(userMessage);

            // Add thinking message
            const thinkingMessage = document.createElement('div');
            thinkingMessage.className = 'message ai thinking';
            thinkingMessage.innerHTML = '<span style="color: #0d82b3;">🤔</span> Thinking...';
            chatMessages.appendChild(thinkingMessage);

            // Clear input and disable button
            document.getElementById('question').value = '';
            sendBtn.disabled = true;
            sendBtn.textContent = 'Sending...';

            // Scroll to bottom
            chatMessages.scrollTop = chatMessages.scrollHeight;

            try {
                // Create enhanced prompt with product context
                const productContext = createProductContext();
                const systemPrompt = `You are a helpful AI assistant for an ecommerce store. You have access to the store's product catalog and can make specific product recommendations.${productContext}

When responding:
1. Be concise and helpful
2. For product recommendations, format each product as: **Product Name** - $Price (brief description)
3. Group similar products together
4. Use bullet points for lists
5. Keep responses under 200 words when possible
6. Always reference actual products from the catalog when making recommendations
7. If asked about availability or stock, check the catalog data`;

                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'llama-3.1-8b-instant',
                        messages: [
                            { role: 'system', content: systemPrompt },
                            { role: 'user', content: question }
                        ],
                        max_tokens: 800,
                        temperature: 0.7
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                
                // Remove thinking message
                chatMessages.removeChild(thinkingMessage);
                
                // Add AI response with enhanced formatting
                const aiMessage = document.createElement('div');
                aiMessage.className = 'message ai';
                
                let content = data.choices[0].message.content;
                content = formatAIResponse(content);
                
                aiMessage.innerHTML = `<div class="content">${content}</div>`;
                chatMessages.appendChild(aiMessage);
                
            } catch (error) {
                console.error('AI Error:', error);
                
                // Remove thinking message
                if (thinkingMessage.parentNode) {
                    chatMessages.removeChild(thinkingMessage);
                }
                
                // Add formatted error message
                const errorMessage = document.createElement('div');
                errorMessage.className = 'message ai';
                errorMessage.innerHTML = `<div class="error-message">
                    <strong>Connection Error</strong><br>
                    ${error.message.includes('Failed to fetch') ? 'Please check your internet connection' : error.message}
                </div>`;
                chatMessages.appendChild(errorMessage);
            } finally {
                // Re-enable button
                sendBtn.disabled = false;
                sendBtn.textContent = 'Send';
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }

        function formatAIResponse(content) {
            // Enhanced formatting for better readability
            
            // Format product recommendations with special styling
            content = content.replace(/\*\*(.*?)\*\* - \$([\d.]+)(.*?)(?=\n|\*\*|$)/g, 
                '<div class="product-recommendation">' +
                '<div class="product-name">$1</div>' +
                '<div class="product-price">$$2</div>' +
                '<div class="product-description">$3</div>' +
                '</div>'
            );
            
            // Format regular bold text
            content = content.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            
            // Format bullet points
            content = content.replace(/^- (.*$)/gm, '• $1');
            content = content.replace(/^• /gm, '<span style="color: #0d82b3; font-weight: bold;">•</span> ');
            
            // Format numbered lists
            content = content.replace(/^(\d+)\. (.*$)/gm, '<span style="color: #0d82b3; font-weight: bold;">$1.</span> $2');
            
            // Convert line breaks to HTML
            content = content.replace(/\n\n/g, '<br><br>');
            content = content.replace(/\n/g, '<br>');
            
            // Format categories/headers (text followed by colon)
            content = content.replace(/^([A-Z\s]+):/gm, '<div class="category-header">$1</div>');
            
            return content;
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                ask();
            }
        }

        function searchMessages() {
            const searchTerm = event.target.value.toLowerCase();
            const messages = document.querySelectorAll('.message');
            
            messages.forEach(message => {
                if (message.textContent.toLowerCase().includes(searchTerm)) {
                    message.style.display = 'block';
                } else {
                    message.style.display = searchTerm ? 'none' : 'block';
                }
            });
        }

        // Close chat when clicking outside
        document.addEventListener('click', function(event) {
            const chatContainer = document.getElementById('chatContainer');
            const chatButton = document.getElementById('chatButton');
            
            if (isChatOpen && 
                !chatContainer.contains(event.target) && 
                !chatButton.contains(event.target)) {
                closeChat();
            }
        });

        // Prevent chat from closing when clicking inside
        document.getElementById('chatContainer').addEventListener('click', function(event) {
            event.stopPropagation();
        });
    </script>
</body>
</html>